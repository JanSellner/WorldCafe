<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Group Allocation</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap-reboot.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='highcharts.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='popper.min.js') }}"></script>
    <script src="{{ url_for('static', filename='tippy.min.js') }}"></script>
</head>
<body>
    <h1>Group Allocation</h1>
    <p>Have you ever been in the situation where you had to calculate an allocation of users to groups across several days with changing groups per day? Then, you are on the right page. If you already know the problem, go directly to the <a href="#sec:input">input section</a> and specify your situation. If not, keep on reading...</p>

    <p>To understand the problem, suppose we have 30 users and three events A, B and C happening per day with a total time budget of three days. We split the users into three groups à 10 people (group I, II and III) and assign each group to an event. So, for the first day we may end up with the allocation A-I, B-II and C-III. On the second day, the we assign the groups to different events, e.g. A-II, B-III, C-I (this leaves the allocation A-III, B-I, and C-II for the last day). In the end, each user participated in each event exactly once.</p>

    <p>The problem with this approach is that only the users from the same group see each other. However, it might be desired that each user meets as many other users as possible during the three days so that we facilitate different discussions. Here, you can run an algorithm which tries to find a better allocation so that the number of different meetings between the users is as high as possible. Simply specify the number of groups/days as well as a list of users and run the algorithm. The results are then directly shown on this page.</p>

    <h2 id="sec:input">Data Input</h2>
    <form action="/" method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}

        {{ form.n_groups.label }}: {{ form.n_groups() }}
        {% for error in form.n_groups.errors %}
            <span class="error">{{ error }}</span>
        {% endfor %}
        <br />

        <div class="tabs">
            {{ (form.selection_type|list)[0] }}
            {{ (form.selection_type|list)[0].label }}
            <div class="tab">
                <p>Please enter the names of the users (one per line):</p>
                {{ form.users(title=form.users.description) }}
                {% for error in form.users.errors %}
                    <span class="error">{{ error }}</span>
                {% endfor %}
                <br />
            </div>

            {{ (form.selection_type|list)[1] }}
            {{ (form.selection_type|list)[1].label }}
            <div class="tab">
                <p>Please upload a valid CSV file according to the following specification:</p>
                <ul>
                    <li>Comma (<code>,</code>) as separator.</li>
                    <li>First row must be a header row.</li>
                    <li>Optionally, one column can be <q>Foreigner</q> with either <code>true</code> or <code>false</code> values. This is interpreted by the system and it tries to find a solution which equally distributes foreigners and non-foreigners over the days.</li>
                </ul>
                {{ form.file.label(title=form.file.description) }}: {{ form.file() }}
                {% for error in form.file.errors %}
                    <span class="error">{{ error }}</span>
                {% endfor %}
                <br />
            </div>
        </div>

        {{ form.submit() }}
        <script>
            document.querySelector('form').addEventListener('submit', function () {
                // Remove any error which may exists
                const serverError = document.getElementById('server_error');
                if (serverError !== null) {
                    serverError.parentNode.removeChild(serverError);
                }
            });
        </script>
        <label for="progress">Progress:</label>
        <progress id="progress" value="{{ form.progress_bar }}"></progress>
        <span id="remaining_time"></span>
    </form>

    {% if error %}
    <p class="error" id="server_error">{{ error }}</p>
    {% endif %}

    {% if stats is defined %}
    <h2>Result</h2>
    {% macro table_day(data) %}
    <table>
        <thead>
            <tr>
                <th>Group</th>
                {% for column in table.columns %}
                <th>{{ column }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for group_data in data %}
                {% for row in group_data.members %}
                <tr>
                    {% if loop.index0 == 0 %}
                    <td rowspan="{{ group_data.members|length }}" data-tippy-content="<span class='tooltip_heading'>{{ group_data.name }}</span>{% if 'foreigners' in group_data %}<br />{{ group_data['non-foreigners'] }} non-foreigners<br>{{ group_data['foreigners'] }} foreigners{% endif %}" >{{ group_data.name }}<br />({{ group_data.members|length }} members)</td>
                    {% endif %}
                    {% for value in row %}
                    <td>{{ value }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}

                {% if loop.index != data|length %}
                <tr class="separator"></tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>
    {% endmacro %}

    <ul>
        {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for message in messages %}
            <li class="warning">{{ message }}</li>
            {% endfor %}
        {% endif %}
        {% endwith %}
        <li>
            {{ stats.members.names|length }} users in total.
            {% if 'n_foreigners' in stats %}
            <ul>
                <li>{{stats['n_non-foreigners']}} non-foreigners</li>
                <li>{{stats['n_foreigners']}} foreigners</li>
            </ul>
            {% endif %}
        </li>
        <li>Error: {{stats.error}} (the lower the better the allocation). Please note that an error of 0 is not possible in general.</li>
        <li>Download the results as <a download="GroupAllocation.csv" href="data:text/csv;base64,{{ csv_data }}">CSV file</a>.</li>
    </ul>

    <div id="stats">
        <div id="member_stats"></div>
        <div id="group_stats"></div>
    </div>
    <script>
        var memberStats = {{ stats.members|safe }};
        var colors = {};
        for (let i = 0; i < memberStats.names.length; ++i) {
            {% if 'n_foreigners' in stats %}
            if (memberStats.foreigners[i] === 0) {
                colors[memberStats.names[i]] = Highcharts.defaultOptions.colors[0];
            }
            else {
                colors[memberStats.names[i]] = Highcharts.defaultOptions.colors[1];
            }
            {% else %}
            colors[memberStats.names[i]] = '#666666';
            {% endif %}
        }

        Highcharts.chart('member_stats', {
            chart: {
                type: 'bar'
            },
            title: {
                text: `How many users does everyone meet? (μ = ${memberStats['meets_others_mean']})`
            },
            xAxis: {
                categories: memberStats['names'],
                labels: {
                    formatter () {
                        return `<span style="color: ${colors[this.value]}">${this.value}</span>`
                    }
                }
            },
            yAxis: {
                min: 0,
                allowDecimals: false,
                title: {
                    text: 'Number of users'
                }
            },
            legend: {
                reversed: true
            },
            tooltip: {
                shared: true
            },
            plotOptions: {
                series: {
                    stacking: 'normal',
                    states: {
                        hover: {
                            brightness: 0.2
                        }
                    }
                }
            },
            series: [
                {% if 'n_foreigners' in stats %}
                {
                    name: 'Non-Foreigners',
                    data: memberStats['meets_non-foreigners']
                },
                {
                    name: 'Foreigners',
                    data: memberStats['meets_foreigners']
                }
                {% else %}
                {
                    showInLegend: false,
                    data: memberStats['meets_others']
                }
                {% endif %}
            ]
        });

        var groupStats = {{ stats.groups|safe }};

        var days = new Array(groupStats.sizes.length);
        var series = [];
        for (let i = 0; i < days.length; ++i) {
            days[i] = 'Day ' + (i + 1);
            series.push({
                name: 'Group ' + (i + 1),
                data: groupStats.sizes[i]
            });
        }

        Highcharts.chart('group_stats', {
            chart: {
                type: 'column'
            },
            title: {
                text: `Group Sizes (μ = ${groupStats['sizes_mean']})`
            },
            xAxis: {
                categories: days,
                crosshair: true
            },
            yAxis: {
                min: 0,
                allowDecimals: false,
                title: {
                    text: 'Number of users'
                }
            },
            tooltip: {
                shared: true
            },
            plotOptions: {
                column: {
                    pointPadding: 0.2,
                    borderWidth: 0
                }
            },
            series: series
        });
    </script>

    {% for data_day in table.days %}
        <details {{ 'open' if loop.index0 == 0 }}>
            <summary>Day {{ loop.index }}</summary>
            {{ table_day(data_day) }}
        </details>
    {% endfor %}

    <script>
        tippy('td[rowspan]', {
            interactive: true
        });
    </script>
    {% endif %}
</body>
</html>
